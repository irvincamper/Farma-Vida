<!DOCTYPE html>
<html lang="es">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Iniciar SesiÃ³n - CuidaMas</title>
Â  Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
Â  Â  <style>
Â  Â  Â  Â  /* --- ESTILOS GENERALES Y DE FONDO --- */
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  background: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 40%, #fbc2eb 70%, #fcd6e6 100%);
Â  Â  Â  Â  Â  Â  font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- BARRA DE NAVEGACIÃ“N SUPERIOR --- */
Â  Â  Â  Â  #neon-navbar {
Â  Â  Â  Â  Â  Â  width: 100vw; position: fixed; top: 0; left: 0; z-index: 200;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 40px 10px #fbc2eb55, 0 0 0 4px #a1c4fd;
Â  Â  Â  Â  Â  Â  border-bottom: 2px solid #a1c4fd;
Â  Â  Â  Â  Â  Â  background: rgba(255,255,255,0.97);
Â  Â  Â  Â  Â  Â  padding: 1.5rem 0;
Â  Â  Â  Â  Â  Â  display: flex; justify-content: center; align-items: center;
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(2px);
Â  Â  Â  Â  }
Â  Â  Â  Â  .navbar-content {
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; gap: 2.5rem; font-size: 2.5rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  .navbar-title {
Â  Â  Â  Â  Â  Â  font-size: 2.7rem; color: #a1c4fd;
Â  Â  Â  Â  Â  Â  text-shadow: 0 0 18px #fbc2eb, 0 0 32px #c2e9fb99;
Â  Â  Â  Â  Â  Â  font-weight: bold; letter-spacing: 2px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .navbar-emoji { animation: emojiMove 3s infinite ease-in-out; }

Â  Â  Â  Â  /* --- CONTENEDOR DEL LOGIN --- */
Â  Â  Â  Â  .login-container {
Â  Â  Â  Â  Â  Â  background: rgba(255,255,255,0.97);
Â  Â  Â  Â  Â  Â  border-radius: 20px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 32px 8px #a1c4fd55, 0 0 0 2px #fbc2eb;
Â  Â  Â  Â  Â  Â  padding: 8rem 2rem 2.5rem 2rem; 
Â  Â  Â  Â  Â  Â  max-width: 350px;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  margin: 10rem auto 2rem auto;
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  display: flex; flex-direction: column; align-items: center;
Â  Â  Â  Â  Â  Â  animation: fadeInUp 1.2s cubic-bezier(.68,-0.55,.27,1.55);
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(2px);
Â  Â  Â  Â  }
Â  Â  Â  Â  .login-container::before {
Â  Â  Â  Â  Â  Â  content: '';
Â  Â  Â  Â  Â  Â  position: absolute; top: -4px; left: -4px; right: -4px; bottom: -4px;
Â  Â  Â  Â  Â  Â  border-radius: 24px; z-index: -1;
Â  Â  Â  Â  Â  Â  background: linear-gradient(90deg, #a1c4fd, #c2e9fb, #fbc2eb, #fcd6e6, #a1c4fd);
Â  Â  Â  Â  Â  Â  background-size: 300% 300%;
Â  Â  Â  Â  Â  Â  filter: blur(10px); opacity: 0.6;
Â  Â  Â  Â  Â  Â  animation: neonBorder 6s linear infinite;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  /* --- ESTILOS DEL LOGO --- */
Â  Â  Â  Â  .login-logo {
Â  Â  Â  Â  Â  Â  width: 150px;
Â  Â  Â  Â  Â  Â  height: 150px;
Â  Â  Â  Â  Â  Â  object-fit: contain;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 1.5rem;
Â  Â  Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  Â  Â  transform: translateX(-50%); 
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  filter: 
Â  Â  Â  Â  Â  Â  Â  Â  drop-shadow(0 0 22px #fbc2eb)
Â  Â  Â  Â  Â  Â  Â  Â  drop-shadow(0 0 14px #a1c4fd);
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  z-index: 10; 
Â  Â  Â  Â  }

Â  Â  Â  Â  .login-title {
Â  Â  Â  Â  Â  Â  color: #6a89cc;
Â  Â  Â  Â  Â  Â  text-shadow: 0 2px 12px #fbc2eb, 0 0 18px #c2e9fb;
Â  Â  Â  Â  Â  Â  font-size: 2rem; text-align: center;
Â  Â  Â  Â  Â  Â  margin-top: 0;
Â  Â  Â  Â  Â  Â  margin-bottom: 1.5rem; 
Â  Â  Â  Â  Â  Â  letter-spacing: 2px; font-weight: 600;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- FORMULARIO --- */
Â  Â  Â  Â  .input-group {
Â  Â  Â  Â  Â  Â  width: 100%; position: relative;
Â  Â  Â  Â  Â  Â  margin-bottom: 1.2rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  .form-control {
Â  Â  Â  Â  Â  Â  width: 100%; box-sizing: border-box;
Â  Â  Â  Â  Â  Â  background: #fcd6e6;
Â  Â  Â  Â  Â  Â  border: 2px solid #a1c4fd;
Â  Â  Â  Â  Â  Â  border-radius: 8px; color: #222;
Â  Â  Â  Â  Â  Â  padding: 0.8rem 1rem; font-size: 1rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  .form-control:focus {
Â  Â  Â  Â  Â  Â  border: 2px solid #6a89cc;
Â  Â  Â  Â  Â  Â  outline: none; box-shadow: 0 0 20px #fbc2eb;
Â  Â  Â  Â  Â  Â  background: #c2e9fb;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-login {
Â  Â  Â  Â  Â  Â  background: linear-gradient(90deg, #a1c4fd 0%, #fbc2eb 100%);
Â  Â  Â  Â  Â  Â  color: #fff; border: none; border-radius: 8px;
Â  Â  Â  Â  Â  Â  padding: 0.8rem 1.5rem; font-size: 1.1rem; font-weight: bold;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 20px #a1c4fd;
Â  Â  Â  Â  Â  Â  cursor: pointer; width: 100%;
Â  Â  Â  Â  Â  Â  letter-spacing: 1px; margin-top: 0.5rem;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- MODAL DE ERROR --- */
Â  Â  Â  Â  .error-modal {
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  position: fixed; top: 0; left: 0;
Â  Â  Â  Â  Â  Â  width: 100%; height: 100%;
Â  Â  Â  Â  Â  Â  background: rgba(20,30,48,0.55);
Â  Â  Â  Â  Â  Â  z-index: 999;
Â  Â  Â  Â  Â  Â  align-items: center; 
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-content {
Â  Â  Â  Â  Â  Â  background: rgba(255,255,255,0.97);
Â  Â  Â  Â  Â  Â  border-radius: 16px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 32px 8px #a1c4fd55, 0 0 0 2px #fbc2eb;
Â  Â  Â  Â  Â  Â  padding: 1.5rem;
Â  Â  Â  Â  Â  Â  max-width: 320px;
Â  Â  Â  Â  Â  Â  width: 90%;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(2px);
Â  Â  Â  Â  Â  Â  animation: fadeInUp 0.5s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-icon { font-size: 2rem; color: #ff3860; margin-bottom: 0.7rem; }
Â  Â  Â  Â  .modal-message { color: #5572a1; font-size: 1.05rem; margin-bottom: 1.2rem; }
Â  Â  Â  Â  .modal-close-btn { background: none; border: none; color: #6a89cc; font-size: 1.1rem; cursor: pointer; font-weight: bold; }

Â  Â  Â  Â  /* --- BOTÃ“N Y ESTADO DEL ASISTENTE DE VOZ --- */
Â  Â  Â  Â  #asistente-btn {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  bottom: 2rem;
Â  Â  Â  Â  Â  Â  right: 2rem;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #a1c4fd, #fbc2eb);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  width: 60px;
Â  Â  Â  Â  Â  Â  height: 60px;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  font-size: 1.8rem;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 20px rgba(0,0,0,0.25), 0 0 30px #a1c4fd;
Â  Â  Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  #asistente-btn:hover { transform: scale(1.1); }
Â  Â  Â  Â  #asistente-btn.active {
Â  Â  Â  Â  Â  Â  animation: pulse 1.5s infinite;
Â  Â  Â  Â  }
Â  Â  Â  Â  #asistente-status {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  bottom: 6rem;
Â  Â  Â  Â  Â  Â  right: 2rem;
Â  Â  Â  Â  Â  Â  background: rgba(0, 0, 0, 0.7);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 0.5rem 1rem;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  Â  Â  Â  display: none; /* Oculto por defecto */
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  /* --- EMOJIS DE FONDO Y ANIMACIONES --- */
Â  Â  Â  Â  .emoji-bg span {
Â  Â  Â  Â  Â  Â  position: absolute; font-size: 5rem; opacity: 0.35;
Â  Â  Â  Â  Â  Â  user-select: none;
Â  Â  Â  Â  Â  Â  animation: move 15s ease-in-out infinite alternate;
Â  Â  Â  Â  }
Â  Â  Â  Â  .emoji-bg span:nth-child(1) { top: 4%; left: 7%; }
Â  Â  Â  Â  .emoji-bg span:nth-child(2) { top: 10%; left: 85%; }
Â  Â  Â  Â  .emoji-bg span:nth-child(3) { top: 18%; left: 30%; animation-delay: 1s; }
Â  Â  Â  Â  .emoji-bg span:nth-child(4) { top: 28%; left: 65%; animation-delay: 2s; }
Â  Â  Â  Â  .emoji-bg span:nth-child(5) { top: 38%; left: 12%; animation-delay: 3s; }
Â  Â  Â  Â  .emoji-bg span:nth-child(6) { top: 52%; left: 80%; animation-delay: 0.5s; }
Â  Â  Â  Â  .emoji-bg span:nth-child(7) { top: 65%; left: 20%; animation-delay: 2.5s; }
Â  Â  Â  Â  .emoji-bg span:nth-child(8) { top: 78%; left: 70%; animation-delay: 1.5s; }
Â  Â  Â  Â  .emoji-bg span:nth-child(9) { top: 90%; left: 45%; animation-delay: 3.5s; }


Â  Â  Â  Â  @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
Â  Â  Â  Â  @keyframes neonBorder { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
Â  Â  Â  Â  @keyframes emojiMove { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-12px) scale(1.1);} }
Â  Â  Â  Â  @keyframes move {
Â  Â  Â  Â  Â  Â  from { transform: translateY(0) rotate(0deg); }
Â  Â  Â  Â  Â  Â  to { transform: translateY(20px) rotate(15deg); }
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes pulse {
Â  Â  Â  Â  Â  Â  0% { box-shadow: 0 4px 20px rgba(0,0,0,0.25), 0 0 30px #fbc2eb; }
Â  Â  Â  Â  Â  Â  50% { box-shadow: 0 6px 30px rgba(0,0,0,0.3), 0 0 40px #a1c4fd; }
Â  Â  Â  Â  Â  Â  100% { box-shadow: 0 4px 20px rgba(0,0,0,0.25), 0 0 30px #fbc2eb; }
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>
Â  Â  <nav id="neon-navbar">
Â  Â  Â  Â  <div class="navbar-content">
Â  Â  Â  Â  Â  Â  <span class="navbar-emoji" id="btn-dashboard" title="Panel">ğŸ’Š</span>
Â  Â  Â  Â  Â  Â  <span class="navbar-emoji" id="btn-inventory" title="Inventario">ğŸ©º</span>
Â  Â  Â  Â  Â  Â  <span class="navbar-title">CuidaMas</span>
Â  Â  Â  Â  Â  Â  <span class="navbar-emoji" id="btn-patients" title="Pacientes">ğŸ§‘â€âš•ï¸</span>
Â  Â  Â  Â  Â  Â  <span class="navbar-emoji" id="btn-prescriptions" title="Recetas">ğŸª</span>
Â  Â  Â  Â  </div>
Â  Â  </nav>
Â  Â  
Â  Â  <div id="error-modal" class="error-modal">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <span class="modal-icon">âš ï¸</span>
Â  Â  Â  Â  Â  Â  <div id="error-message" class="modal-message"></div>
Â  Â  Â  Â  Â  Â  <button id="close-error-modal" class="modal-close-btn">Cerrar</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="emoji-bg">
Â  Â  Â  Â  <span>ğŸ’Š</span> <span>ğŸ©º</span> <span>ğŸ§¬</span> <span>ğŸ©¹</span>
Â  Â  Â  Â  <span>ğŸ§ª</span> <span>ğŸ¥</span> <span>ğŸŒ¡ï¸</span> <span>ğŸ’‰</span> <span>ğŸ”¬</span>
Â  Â  </div>

Â  Â  <button type="button" id="asistente-btn" title="Activar Asistente de Voz">
Â  Â  Â  Â  <i class="fa-solid fa-microphone"></i>
Â  Â  </button>
Â  Â  <div id="asistente-status">Escuchando...</div>


Â  Â  <div class="login-container">
Â  Â  Â  Â  <img src="{{ url_for('static', filename='logo-farma.png') }}" alt="Logo" class="login-logo">
Â  Â  Â  Â  
Â  Â  Â  Â  <div class="login-title">Iniciar SesiÃ³n</div>
Â  Â  Â  Â  
Â  Â  Â  Â  <form method="POST" action="{{ url_for('auth.login') }}" id="login-form">
Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="email" name="email" class="form-control" placeholder="Correo electrÃ³nico" required id="email-input">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" name="password" class="form-control" placeholder="ContraseÃ±a" required id="password-input">
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="toggle-password" 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aria-label="Mostrar ContraseÃ±a" Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  style="position:absolute; right:10px; top:50%; transform:translateY(-50%);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â background:none; border:none; color:#6a89cc; font-size:1.2rem; cursor:pointer;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa-regular fa-eye" id="eye-icon"></i>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button type="submit" class="btn-login">Entrar</button>
Â  Â  Â  Â  </form>
Â  Â  </div>

Â  Â  {% with messages = get_flashed_messages(with_categories=true) %}
Â  Â  Â  {% if messages %}
Â  Â  Â  Â  <script>
Â  Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', function() {
Â  Â  Â  Â  Â  Â  var modal = document.getElementById('error-modal');
Â  Â  Â  Â  Â  Â  var msgDiv = document.getElementById('error-message');
Â  Â  Â  Â  Â  Â  {% for category, message in messages %}
Â  Â  Â  Â  Â  Â  Â  {% if category == 'danger' or category == 'warning' %}
Â  Â  Â  Â  Â  Â  Â  Â  msgDiv.innerText = "Error: Correo o contraseÃ±a incorrecta";
Â  Â  Â  Â  Â  Â  Â  Â  modal.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  {% endif %}
Â  Â  Â  Â  Â  Â  {% endfor %}
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  </script>
Â  Â  Â  {% endif %}
Â  Â  {% endwith %}

Â  Â  <script>
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', function() {
Â  Â  Â  Â  Â  Â  // --- LÃ“GICA DE LOGIN EXISTENTE ---
Â  Â  Â  Â  Â  Â  var modal = document.getElementById('error-modal');
Â  Â  Â  Â  Â  Â  var closeBtn = document.getElementById('close-error-modal');
Â  Â  Â  Â  Â  Â  if (modal && closeBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  closeBtn.onclick = function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  modal.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  var toggleBtn = document.getElementById('toggle-password');
Â  Â  Â  Â  Â  Â  var pwdInput = document.getElementById('password-input');
Â  Â  Â  Â  Â  Â  var eyeIcon = document.getElementById('eye-icon');
Â  Â  Â  Â  Â  Â  if (toggleBtn && pwdInput) {
Â  Â  Â  Â  Â  Â  Â  Â  toggleBtn.addEventListener('click', function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  var isVisible = pwdInput.type === 'text';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pwdInput.type = isVisible ? 'password' : 'text';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  eyeIcon.className = isVisible ? 'fa-regular fa-eye-slash' : 'fa-regular fa-eye';
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- LÃ“GICA DE NAVEGACIÃ“N EXISTENTE ---
Â  Â  Â  Â  Â  Â  document.getElementById('btn-dashboard')?.addEventListener('click', function() {
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = "{{ url_for('pharmacist.dashboard') }}";
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  document.getElementById('btn-inventory')?.addEventListener('click', function() {
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = "{{ url_for('pharmacist.inventory') }}";
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  document.getElementById('btn-patients')?.addEventListener('click', function() {
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = "{{ url_for('pharmacist.view_patients') }}";
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  document.getElementById('btn-prescriptions')?.addEventListener('click', function() {
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = "{{ url_for('pharmacist.view_prescriptions') }}";
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // --- ASISTENTE DE VOZ (CONTINUO + TEMPORIZADOR) ---

Â  Â  Â  Â  Â  Â  var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
Â  Â  Â  Â  Â  Â  var wakeWordRecognition; 
Â  Â  Â  Â  Â  Â  var sharedRecognition;
Â  Â  Â  Â  Â  Â  var audioCtx = window.AudioContext ? new window.AudioContext() : null;

Â  Â  Â  Â  Â  Â  var asistenteBtn = document.getElementById('asistente-btn');
Â  Â  Â  Â  Â  Â  var statusDiv = document.getElementById('asistente-status');
Â  Â  Â  Â  Â  Â  var emailInput = document.getElementById('email-input');
Â  Â  Â  Â  Â  Â  var pwdInput = document.getElementById('password-input');
Â  Â  Â  Â  Â  Â  var loginForm = document.getElementById('login-form');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  var isListeningForWakeWord = false;
Â  Â  Â  Â  Â  Â  let speechTimeout = null;
Â  Â  Â  Â  Â  Â  let currentTranscript = "";

Â  Â  Â  Â  Â  Â  // FunciÃ³n de Beep (para el tiempo)
Â  Â  Â  Â  Â  Â  function playBeep(callback) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!audioCtx) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (callback) callback();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  var oscillator = audioCtx.createOscillator();
Â  Â  Â  Â  Â  Â  Â  Â  var gainNode = audioCtx.createGain();
Â  Â  Â  Â  Â  Â  Â  Â  oscillator.connect(gainNode);
Â  Â  Â  Â  Â  Â  Â  Â  gainNode.connect(audioCtx.destination);
Â  Â  Â  Â  Â  Â  Â  Â  oscillator.type = 'sine';
Â  Â  Â  Â  Â  Â  Â  Â  oscillator.frequency.value = 880;
Â  Â  Â  Â  Â  Â  Â  Â  gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
Â  Â  Â  Â  Â  Â  Â  Â  gainNode.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 0.01);
Â  Â  Â  Â  Â  Â  Â  Â  oscillator.start(audioCtx.currentTime);
Â  Â  Â  Â  Â  Â  Â  Â  gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1);
Â  Â  Â  Â  Â  Â  Â  Â  oscillator.stop(audioCtx.currentTime + 0.1);
Â  Â  Â  Â  Â  Â  Â  Â  oscillator.onended = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (callback) callback();
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // FunciÃ³n para que el asistente hable
Â  Â  Â  Â  Â  Â  function speak(text, callback) {
Â  Â  Â  Â  Â  Â  Â  Â  try { sharedRecognition.stop(); } catch(e) {}
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if ('speechSynthesis' in window) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  var utter = new SpeechSynthesisUtterance(text);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  utter.lang = 'es-ES';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  utter.onend = function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playBeep(callback);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.speechSynthesis.speak(utter);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playBeep(callback);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Procesador para el CORREO (NÃºmeros y SÃ­mbolos)
Â  Â  Â  Â  Â  Â  function processTranscript(transcript) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!transcript) return "";
Â  Â  Â  Â  Â  Â  Â  Â  let processed = transcript.toLowerCase();
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // SÃ­mbolos (sin \b para que funcione si estÃ¡n pegados)
Â  Â  Â  Â  Â  Â  Â  Â  processed = processed.replace(/guion bajo/g, '_');
Â  Â  Â  Â  Â  Â  Â  Â  processed = processed.replace(/arroba/g, '@');
Â  Â  Â  Â  Â  Â  Â  Â  processed = processed.replace(/punto/g, '.');
Â  Â  Â  Â  Â  Â  Â  Â  processed = processed.replace(/guion/g, '-');
Â  Â  Â  Â  Â  Â  Â  Â  processed = processed.replace(/gato/g, '#');
Â  Â  Â  Â  Â  Â  Â  Â  processed = processed.replace(/numeral/g, '#');
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // NÃºmeros (sin \b)
Â  Â  Â  Â  Â  Â  Â  Â  processed = processed.replace(/cero/g, '0');
Â  Â  Â  Â  Â  Â  Â  Â  processed = processed.replace(/uno/g, '1');
Â  Â  Â  Â  Â  Â  Â  Â  processed = processed.replace(/dos/g, '2');
Â  Â  Â  Â  Â  Â  Â  Â  processed = processed.replace(/tres/g, '3');
Â  Â  Â  Â  Â  Â  Â  Â  processed = processed.replace(/cuatro/g, '4');
Â  Â  Â  Â  Â  Â  Â  Â  processed = processed.replace(/cinco/g, '5');
Â  Â  Â  Â  Â  Â  Â  Â  processed = processed.replace(/seis/g, '6');
Â  Â  Â  Â  Â  Â  Â  Â  processed = processed.replace(/siete/g, '7');
Â  Â  Â  Â  Â  Â  Â  Â  processed = processed.replace(/ocho/g, '8');
Â  Â  Â  Â  Â  Â  Â  Â  processed = processed.replace(/nueve/g, '9');
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  return processed;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 1. Iniciar/Detener la escucha de la palabra clave
Â  Â  Â  Â  Â  Â  if (asistenteBtn && SpeechRecognition) {
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  wakeWordRecognition = new SpeechRecognition();
Â  Â  Â  Â  Â  Â  Â  Â  wakeWordRecognition.lang = 'es-ES';
Â  Â  Â  Â  Â  Â  Â  Â  wakeWordRecognition.continuous = true;
Â  Â  Â  Â  Â  Â  Â  Â  wakeWordRecognition.interimResults = false;

Â  Â  Â  Â  Â  Â  Â  Â  asistenteBtn.onclick = function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (audioCtx && audioCtx.state === 'suspended') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  audioCtx.resume();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isListeningForWakeWord) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  wakeWordRecognition.stop();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isListeningForWakeWord = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  asistenteBtn.classList.remove('active');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusDiv.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  wakeWordRecognition.start();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isListeningForWakeWord = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  asistenteBtn.classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusDiv.innerHTML = "Di 'Oye CuidaMas'";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusDiv.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al iniciar reconocimiento:", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusDiv.innerHTML = "Error de micrÃ³fono";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  wakeWordRecognition.onresult = function(event) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (var i = event.resultIndex; i < event.results.length; ++i) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  var transcript = event.results[i][0].transcript.trim().toLowerCase();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (transcript.includes("oye cuida mÃ¡s") || transcript.includes("hola cuida mÃ¡s")) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  wakeWordRecognition.stop();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isListeningForWakeWord = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  asistenteBtn.classList.remove('active');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startLoginSequence();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  wakeWordRecognition.onend = function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isListeningForWakeWord) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try { wakeWordRecognition.start(); } catch(e) {}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  // Pre-inicializar el objeto compartido
Â  Â  Â  Â  Â  Â  Â  Â  sharedRecognition = new SpeechRecognition();
Â  Â  Â  Â  Â  Â  Â  Â  sharedRecognition.lang = 'es-ES';
Â  Â  Â  Â  Â  Â  Â  Â  sharedRecognition.continuous = true;
Â  Â  Â  Â  Â  Â  Â  Â  sharedRecognition.interimResults = true; 

Â  Â  Â  Â  Â  Â  } else if (asistenteBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  asistenteBtn.style.display = 'none'; // Ocultar si no hay soporte
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 3. Secuencia de Login
Â  Â  Â  Â  Â  Â  function startLoginSequence() {
Â  Â  Â  Â  Â  Â  Â  Â  statusDiv.innerHTML = "Â¡Hola! Di tu correo.";
Â  Â  Â  Â  Â  Â  Â  Â  statusDiv.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  speak("Â¡Hola! Soy el asistente de CuidaMas. Por favor, di tu correo electrÃ³nico.", listenForEmail);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  function listenForEmail() {
Â  Â  Â  Â  Â  Â  Â  Â  statusDiv.innerHTML = "Escuchando correo...";
Â  Â  Â  Â  Â  Â  Â  Â  statusDiv.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  currentTranscript = "";

Â  Â  Â  Â  Â  Â  Â  Â  sharedRecognition.onresult = function(event) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearTimeout(speechTimeout);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let interimTranscript = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let finalTranscript = "";

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (let i = event.resultIndex; i < event.results.length; ++i) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let transcript = event.results[i][0].transcript;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (event.results[i].isFinal) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  finalTranscript += transcript.trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  interimTranscript += transcript;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentTranscript = finalTranscript || currentTranscript;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // LÃ“GICA DE CORREO: Procesar sÃ­mbolos + Quitar espacios
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  emailInput.value = processTranscript(interimTranscript || currentTranscript).replace(/\s+/g, '');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Temporizador estÃ¡ndar para el correo
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  speechTimeout = setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Fin de habla detectado (Email).");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sharedRecognition.stop();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  emailInput.value = processTranscript(currentTranscript).replace(/\s+/g, '');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusDiv.innerHTML = "Escuchando contraseÃ±a...";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  speak("Correo registrado. Ahora, di tu contraseÃ±a.", listenForPassword);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 1500); // 1.5 segundos de silencio
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  sharedRecognition.onerror = function(event) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (event.error !== 'no-speech' && event.error !== 'aborted') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  speak("No te entendÃ­. Por favor, activa el asistente de nuevo.", () => statusDiv.style.display = 'none');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sharedRecognition.start();
Â  Â  Â  Â  Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al iniciar escucha de email:", e);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function listenForPassword() {
Â  Â  Â  Â  Â  Â  Â  Â  statusDiv.innerHTML = "Escuchando contraseÃ±a...";
Â  Â  Â  Â  Â  Â  Â  Â  statusDiv.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  currentTranscript = "";

Â  Â  Â  Â  Â  Â  Â  Â  sharedRecognition.onresult = function(event) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearTimeout(speechTimeout);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let interimTranscript = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let finalTranscript = "";

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (let i = event.resultIndex; i < event.results.length; ++i) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let transcript = event.results[i][0].transcript;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (event.results[i].isFinal) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  finalTranscript += transcript.trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  interimTranscript += transcript;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentTranscript = finalTranscript || currentTranscript;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // LÃ“GICA DE CONTRASEÃ‘A: Literal + Quitar espacios
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pwdInput.value = (interimTranscript || currentTranscript).replace(/\s+/g, '');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- Â¡CAMBIO CLAVE! Temporizador mÃ¡s largo para la contraseÃ±a ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  speechTimeout = setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Fin de habla detectado (Pass).");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sharedRecognition.stop();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pwdInput.value = currentTranscript.replace(/\s+/g, '');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusDiv.innerHTML = "Iniciando sesiÃ³n...";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  speak("Perfecto. Iniciando sesiÃ³n.", function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusDiv.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loginForm.submit();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 3000); // 3 segundos de silencio
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  sharedRecognition.onerror = function(event) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (event.error !== 'no-speech' && event.error !== 'aborted') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  speak("No te entendÃ­ la contraseÃ±a. Por favor, activa el asistente de nuevo.", () => statusDiv.style.display = 'none');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sharedRecognition.start();
Â  Â  Â  Â  Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al iniciar escucha de pass:", e);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  </script>
</body>
</html> busca ese boton y corrige esas lineas