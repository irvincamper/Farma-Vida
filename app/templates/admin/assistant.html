{% extends 'layout/base.html' %}
{% block title %}Asistente (Admin){% endblock %}
{% block content %}
<header class="header mb-4">
    <h1><i class="fas fa-robot"></i> Asistente del Administrador</h1>
    <p class="text-muted">Plantea preguntas sobre el sistema, estadísticas o tareas administrativas.</p>
</header>

<div class="row justify-content-center">
    <div class="col-12 col-md-10 col-lg-8">
        <div class="card shadow-sm">
            <div class="card-body">
                <div id="chatBox" style="min-height:300px; max-height:500px; overflow:auto; border:1px solid #eee; padding:1rem; border-radius:8px; background:#fafafa"></div>
                
                <div class="mt-3 d-flex gap-2 chat-input-area">
                    <input id="msgInput" class="form-control" placeholder="Escribe tu pregunta para el asistente..." />
                    
                    <button type="button" id="micBtn" class="btn btn-secondary" title="Activar entrada de voz">
                        <i class="fas fa-microphone"></i>
                    </button>
                    
                    <button id="sendBtn" class="btn btn-primary">Enviar</button>
                </div>
                
                <div id="status" class="small text-muted mt-2"></div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    // --- VARIABLES DE CONFIGURACIÓN ---
    const USER_NAME = "{{ user_name }}"; 
    const ASSISTANT_ROLE = "Asistente";
    const WELCOME_MESSAGE = "Hola. Soy tu Asistente experto en la administración del sistema Cuida Mas. Estoy aquí para ayudarte con estadísticas, conteos, y preguntas generales. ¿En qué puedo asistirte hoy?";


    // Variables globales (acceso rápido a elementos del DOM)
    const chatBox = document.getElementById('chatBox');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');
    const micBtn = document.getElementById('micBtn');
    const statusDiv = document.getElementById('status');

    let isListening = false;
    let recognition = null;
    let speechTimeout = null;

    // --- FUNCIONES DE CHAT ---

    async function sendMessage() {
        if (isListening) stopListening(false); 
        
        const text = msgInput.value.trim();
        if (!text) return;

        addMessage(USER_NAME, text); 
        msgInput.value = '';
        setStatus('Enviando consulta al Asistente…', 'primary');
        msgInput.disabled = true;
        sendBtn.disabled = true;
        micBtn.disabled = true;

        try {
            const res = await fetch('{{ url_for('admin.assistant_api') }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            });
            const j = await res.json();
            if (j.ok) {
                addMessage(ASSISTANT_ROLE, j.response);
                setStatus('Listo');
            } else {
                addMessage(ASSISTANT_ROLE + ' (error)', j.response || 'Error de servicio: Sin respuesta');
                setStatus('Error: Inténtalo de nuevo.', 'danger');
            }
        } catch (e) {
            addMessage(ASSISTANT_ROLE + ' (error)', 'Error de conexión: ' + String(e));
            setStatus('Error de conexión.', 'danger');
        } finally {
            msgInput.disabled = false;
            sendBtn.disabled = false;
            micBtn.disabled = false;
            msgInput.focus();
        }
    }

    function addMessage(role, text) {
        const el = document.createElement('div');
        el.className = 'mb-2';
        
        const isUser = role === USER_NAME;
        const roleClass = isUser ? 'text-primary' : 'text-success';
        const roleIcon = isUser ? '<i class="fas fa-user-circle"></i>' : '<i class="fas fa-robot"></i>';
        
        el.innerHTML = `<strong class="${roleClass}">${roleIcon} ${role}:</strong> <div class="small text-dark">${escapeHtml(text)}</div>`;
        
        chatBox.appendChild(el);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function setStatus(t, category = 'muted') { 
        statusDiv.className = `small mt-2 text-${category}`;
        statusDiv.innerText = t; 
    }

    function escapeHtml(text) {
        // Se mantiene para seguridad. Si deseas que el LLM use formatos (negritas, listas), 
        // tendrías que usar una librería de Markdown a HTML aquí.
        return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    // --- FUNCIONES DE RECONOCIMIENTO DE VOZ ---
    
    function initSpeechRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            micBtn.style.display = 'none';
            setStatus('ERROR: El reconocimiento de voz no está soportado.', 'danger'); 
            return null;
        }
        
        const recognizer = new SpeechRecognition();
        recognizer.lang = 'es-ES';
        recognizer.continuous = true;
        recognizer.interimResults = true;
        return recognizer;
    }

    function startListening() {
        if (!recognition) {
            setStatus('El micrófono no puede iniciar. ¿Está usando HTTPS?', 'danger');
            return;
        }
        
        clearTimeout(speechTimeout); 

        if (isListening) {
            setStatus('Micrófono activo. Habla ahora...');
            return;
        }

        if (!msgInput.value.trim()) msgInput.value = '';

        try {
            recognition.start();
            isListening = true;
            micBtn.classList.add('btn-danger'); 
            micBtn.classList.remove('btn-secondary');
            sendBtn.disabled = true; 
            micBtn.innerHTML = '<i class="fas fa-microphone-alt"></i>';
            setStatus('Escuchando... Di tu pregunta y haz una pausa al terminar.', 'success');
        } catch (e) {
            console.error("Error al iniciar reconocimiento:", e);
            setStatus(`Error al iniciar: ${e.message}. El micrófono ya está activo o permiso falló.`, 'danger');
            if (e.message.includes("recognition already started")) {
                isListening = true; 
                stopListening(false);
            }
        }
    }

    function stopListening(submitFinalText = true) {
        if (!recognition) return;

        clearTimeout(speechTimeout);

        if (isListening) {
            try {
                recognition.stop(); 
            } catch(e) {}
        }
        
        isListening = false;
        micBtn.classList.remove('btn-danger');
        micBtn.classList.add('btn-secondary');
        sendBtn.disabled = false;
        micBtn.innerHTML = '<i class="fas fa-microphone"></i>';

        if (submitFinalText && msgInput.value.trim()) {
            setStatus('Texto finalizado. Presiona Enviar.', 'info');
        } else if (!submitFinalText) {
            setStatus('Listo');
        }
    }

    // --- INICIALIZACIÓN DE CHAT Y RECONOCIMIENTO ---

    function initializeChat() {
        // 1. Mostrar el mensaje de bienvenida del Asistente
        addMessage(ASSISTANT_ROLE, WELCOME_MESSAGE);

        // 2. Inicializar el objeto de reconocimiento
        recognition = initSpeechRecognition();
        
        if (recognition) {
            // 3. Asignar todos los manejadores de eventos del objeto de reconocimiento
            recognition.onresult = function(event) {
                clearTimeout(speechTimeout); 
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    let transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript.trim() + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                msgInput.value = (finalTranscript || interimTranscript).trim();
                setStatus('Grabando: ' + msgInput.value, 'success');

                speechTimeout = setTimeout(() => {
                    console.log("Fin de habla detectado (Silencio).");
                    stopListening(true); 
                }, 3000); 
            };

            recognition.onerror = function(event) {
                console.error("Error de reconocimiento:", event.error);
                if (isListening) {
                    if (event.error === 'no-speech') {
                        setStatus('No se detectó habla. Inténtalo de nuevo.', 'warning');
                    } else if (event.error === 'not-allowed') {
                        setStatus('Permiso denegado. Habilita el micrófono en la configuración del navegador.', 'danger');
                    } else if (event.error !== 'aborted') {
                        setStatus(`Error: ${event.error}`, 'danger');
                    }
                }
                stopListening(false); 
            };
            
            recognition.onend = function() {
                if (isListening) {
                    console.log("Reconocimiento finalizado inesperadamente, limpiando estado.");
                    stopListening(true); 
                }
            };
        }

        // 4. Inicializar el estado de la aplicación
        if (!recognition) {
            // El status ya fue configurado por initSpeechRecognition
        } else {
            setStatus('Listo');
        }
    }


    // --- ASIGNACIÓN DE EVENTOS A BOTONES (Siempre se ejecutan) ---
    
    micBtn.addEventListener('click', function() {
        if (isListening) {
            stopListening(true); 
        } else {
            startListening();
        }
    });

    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('msgInput').addEventListener('keydown', function(e){ 
        if (e.key === 'Enter' && !e.shiftKey) { 
            e.preventDefault(); 
            sendMessage(); 
        } 
    });
    
    // Iniciar el chat
    initializeChat();

</script>
{% endblock %}

{% endblock %}