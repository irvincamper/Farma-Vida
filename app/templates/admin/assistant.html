{% extends 'layout/base.html' %}
{% block title %}Asistente (Admin){% endblock %}
{% block content %}
<header class="header mb-4"><h1><i class="fas fa-robot"></i> Asistente del Administrador</h1><p class="text-muted">Plantea preguntas sobre el sistema, estadísticas o tareas administrativas.</p></header>

<div class="row justify-content-center">
  <div class="col-12 col-md-10 col-lg-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <div id="chatBox" style="min-height:300px; max-height:500px; overflow:auto; border:1px solid #eee; padding:1rem; border-radius:8px; background:#fafafa"></div>
        <div class="mt-3 d-flex gap-2">
          <input id="msgInput" class="form-control" placeholder="Escribe tu pregunta para el asistente..." />
          <button id="sendBtn" class="btn btn-primary">Enviar</button>
        </div>
        <div id="status" class="small text-muted mt-2"></div>
      </div>
    </div>
  </div>
</div>

{% block scripts %}
<script>
async function sendMessage() {
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if (!text) return;
  addMessage('Tú', text);
  input.value = '';
  setStatus('Enviando…');

  try {
    const res = await fetch('{{ url_for('admin.assistant_api') }}', {
      method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({message: text})
    });
    const j = await res.json();
    if (j.ok) addMessage('Asistente', j.response);
    else addMessage('Asistente (error)', j.response || 'Sin respuesta');
  } catch (e) {
    addMessage('Asistente (error)', String(e));
  } finally {
    setStatus('Listo');
  }
}

function addMessage(role, text) {
  const box = document.getElementById('chatBox');
  const el = document.createElement('div');
  el.className = 'mb-2';
  el.innerHTML = `<strong>${role}:</strong> <div class="small text-muted">${escapeHtml(text)}</div>`;
  box.appendChild(el);
  box.scrollTop = box.scrollHeight;
}

function setStatus(t) { document.getElementById('status').innerText = t; }

function escapeHtml(text) { return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

document.getElementById('sendBtn').addEventListener('click', sendMessage);
document.getElementById('msgInput').addEventListener('keydown', function(e){ if (e.key==='Enter') sendMessage(); });
setStatus('Listo');
</script>
{% endblock %}

{% endblock %}
