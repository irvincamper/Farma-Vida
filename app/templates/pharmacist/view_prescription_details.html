{% extends 'layout/base.html' %}

{# Título con comprobación de seguridad #}
{% block title %}Detalle de Receta #{{ prescription.id if prescription else 'N/A' }}{% endblock %}

{% block content %}
    
    {# --- INICIO DE COMPROBACIÓN DE SEGURIDAD CRÍTICA --- #}
    {% if not prescription %}
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">Error de Carga</h4>
            <p>No se pudieron cargar los detalles de la receta. La receta no existe o hubo un error al obtener la información.</p>
            <hr>
            <a href="{{ url_for('pharmacist.view_prescriptions') }}" class="btn btn-danger">Volver a Recetas</a>
        </div>
        
    {% else %}
    {# --- INICIO DEL CONTENIDO NORMAL SOLO SI 'prescription' EXISTE --- #}
    
    <header class="header">
        <h1><i class="fas fa-file-prescription"></i> Detalle de Receta #{{ prescription.id }}</h1>
        <p>Información detallada de la prescripción emitida el {{ prescription.created_at | default('N/A') | truncate(10, True, '') }}.</p>
    </header>
    
    <div class="row">
        
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Información General</h5>
                </div>
                <div class="card-body">
                    <p><strong>Doctor:</strong> {{ prescription.doctor.nombre_completo if prescription.doctor else "N/A" }}</p>
                    <p><strong>Fecha de Emisión:</strong> {{ prescription.created_at | default('N/A') }}</p>
                    <p><strong>Notas del Doctor:</strong> {{ prescription.notas if prescription.notas else 'Sin notas' }}</p>
                    <p><strong>Estado:</strong> 
                        {% if prescription.estado == 'activa' %}
                            <span class="badge bg-success">Activa</span>
                        {% elif prescription.estado == 'finalizada' %}
                            <span class="badge bg-secondary">Finalizada</span>
                        {% else %}
                            <span class="badge bg-warning text-dark">{{ prescription.estado | default('Pendiente') }}</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Paciente</h5>
                </div>
                <div class="card-body">
                    <p><strong>Nombre:</strong> {{ prescription.paciente.nombre_completo if prescription.paciente else "N/A" }}</p>
                    <p><strong>ID Paciente:</strong> {{ prescription.id_paciente | default("N/A") }}</p>
                    <p><strong>Fecha Nacimiento:</strong> {{ prescription.paciente.fecha_nacimiento if prescription.paciente else "N/A" }}</p>
                    <p><strong>Peso:</strong> {{ prescription.peso_paciente_kg | default('N/A') }} kg</p>
                    <p><strong>Altura:</strong> {{ prescription.altura_paciente_cm | default('N/A') }} cm</p>
                </div>
            </div>
        </div>
        
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Tratamiento, Posología y Recomendaciones</h5>
                </div>
                <div class="card-body">
                    
                    <h6 class="fw-bold text-primary">Tratamiento Prescrito:</h6>
                    <p class="border border-info p-3 rounded bg-light text-wrap">
                        {{ prescription.tratamiento | default('N/A') }}
                    </p>
                    
                    <h6 class="fw-bold text-primary mt-3">Recomendaciones:</h6>
                    <p class="border border-warning p-3 rounded bg-light text-wrap">
                        {{ prescription.recomendaciones | default('Sin recomendaciones adicionales') }}
                    </p>
                    
                    {% if prescription.medicamentos_data %}
                        <h6 class="fw-bold text-primary mt-3">Detalle de Medicamentos:</h6>
                        <ul class="list-group">
                        {% for med in prescription.medicamentos_data %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ med.nombre | default('Medicamento sin nombre') }}
                                <span class="badge bg-secondary rounded-pill">{{ med.dosis | default('N/A') }}</span>
                            </li>
                        {% endfor %}
                        </ul>
                    {% endif %}

                    <p class="mt-3 text-muted">
                        <small>Esta sección muestra los campos de tratamiento y recomendaciones presentes en la receta.</small>
                    </p>
                    
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <a href="{{ url_for('pharmacist.view_prescriptions') }}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Volver a Recetas</a>
        {# Botones de acción como 'Despachar' irían aquí #}
    </div>
    
    {# --- FIN DEL CONTENIDO NORMAL --- #}
    {% endif %} 
{% endblock %}